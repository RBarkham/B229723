---
title: "Assesment"
output: html_document
date: "2025-10-31"
runtime: shiny
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
options(timeout = 600)
```

# R Programing Assignment - B229723
### Is there an assocation between antibiotic perscription rate and the seasons? How does this vary by healthboard?



##### First, lets load out packages in
```{R, message=FALSE}
library(tidyverse)
library(janitor)
library(gt) 
library(here)
library(sf)
library(raster)
library(terra)
library(ncdf4)
library(tidync)
library(exactextractr)
library(shiny)
library(shinytest2)
```

##### And now our data, we'll be looking from June-December (Summer to winter) across 2023, and 2024. These data files are large, so it may take some time for the chunk to run. (Only doing 2024 for now)



```{r}
Temp_raw_2024 = rast("temp_2024.nc")
```


```{r, message=FALSE}
map = st_read("data/shapefile/NHS_Healthboards_2019.shp", quiet = TRUE) %>% 
  st_transform( crs(Temp_raw_2024))
```

```{r}
Temp_2024 = exact_extract(Temp_raw_2024, map, 'mean', append_cols = "HBName") 

Temp_2024 = Temp_2024 %>% 
    dplyr::select(c(1,7:13)) # a lot of packages in tidyverse use select() as a command, if we don't specify what package's select we want to use, it will get confused, so we add dplyr:: in front of select()
  colnames(Temp_2024)[-1] = c("Jun","Jul","Aug","Sep","Oct","Nov","Dec")

Temp_map_2024 = Temp_2024 %>% 
  #lets pipe our temp data into our joining function, we ideally want to keep the less important infomation (shape and geometry) our of the way, by specifying map as the second dataset, it will add it to the right-hand side.
  
  full_join(map) %>%  
  #here, we tell it to join with map. If we use full_join, it makes sure there are no empty rows.
  
  st_as_sf(sf_column_name = "geometry") # when we joined, the data lost its sf properties which make it suitbale for map plotting, we can restore it with st_as_sf()

#If we didn't want our data to be as neat, we could have swapped the order of Temp_2024 and map in our full_join and skipped the st_as_sf() stage. However, by doing it this way its easier to read our data as we work because our names are next to the temperatures
```

```{r}
ggplot(Temp_map_2024) +
  geom_sf(aes(fill = Jun)) +
  scale_fill_viridis_c() +
  theme_minimal() +
  labs(fill = "Jun Temp (°C)")
```





```{R, message=FALSE}


data_jun_2023 = read_csv("https://www.opendata.nhs.scot/dataset/84393984-14e9-4b0d-a797-b288db64d088/resource/66e9611a-fbea-45b2-9edd-351c388fd06d/download/pitc202306.csv") %>% 
  clean_names()

data_jul_2023 = read.csv("https://www.opendata.nhs.scot/dataset/84393984-14e9-4b0d-a797-b288db64d088/resource/7bb45ee6-6f1c-45f4-933b-958bdbe0ca4f/download/pitc202307.csv") %>% 
  clean_names()

data_aug_2023 = read.csv("https://www.opendata.nhs.scot/dataset/84393984-14e9-4b0d-a797-b288db64d088/resource/72ca4ad2-0228-4672-9eb0-cc911e4a8ca7/download/pitc202308.csv") %>% 
  clean_names()

data_sep_2023 = read_csv("https://www.opendata.nhs.scot/dataset/84393984-14e9-4b0d-a797-b288db64d088/resource/2d3d240f-1467-4a91-9f0e-769745650cb9/download/pitc202309.csv") %>% 
  clean_names()

data_oct_2023 = read_csv("https://www.opendata.nhs.scot/dataset/84393984-14e9-4b0d-a797-b288db64d088/resource/94134438-db1d-4b8d-8f70-5e9b0e47bd03/download/pitc202310.csv") %>% 
  clean_names()

data_nov_2023 = read_csv("https://www.opendata.nhs.scot/dataset/84393984-14e9-4b0d-a797-b288db64d088/resource/21d11fed-a494-4e30-9bb6-46143c3b9530/download/pitc202311.csv") %>% 
  clean_names()

data_dec_2023 = read_csv("https://www.opendata.nhs.scot/dataset/84393984-14e9-4b0d-a797-b288db64d088/resource/00cdf8d7-f784-4e87-894c-34f2540ea6ab/download/pitc202312.csv") %>% 
  clean_names()

data_jun_2024 = read_csv("https://www.opendata.nhs.scot/dataset/84393984-14e9-4b0d-a797-b288db64d088/resource/95f7f250-bd04-4e4a-b853-5df75b00a632/download/pitc202406.csv") %>% 
  clean_names()

data_jul_2024 = read_csv("https://www.opendata.nhs.scot/dataset/84393984-14e9-4b0d-a797-b288db64d088/resource/1cb425fc-640c-4b37-9013-f8e97f274085/download/pitc202407.csv") %>% 
  clean_names()

data_aug_2024 = read_csv("https://www.opendata.nhs.scot/dataset/84393984-14e9-4b0d-a797-b288db64d088/resource/e4985a62-9d59-4e71-8800-3f7ca29ffe0c/download/pitc202408.csv") %>% 
  clean_names()

data_sep_2024 <- read_csv("https://www.opendata.nhs.scot/dataset/84393984-14e9-4b0d-a797-b288db64d088/resource/d1fbede3-98c4-436e-9e75-2ed807a36075/download/pitc202409.csv") %>% 
  clean_names()

data_oct_2024 = read_csv("https://www.opendata.nhs.scot/dataset/84393984-14e9-4b0d-a797-b288db64d088/resource/0d27f6e8-5f8b-42c4-9fe9-c44389af2d3e/download/pitc202410.csv") %>% 
  clean_names()

data_nov_2024 = read_csv("https://www.opendata.nhs.scot/dataset/84393984-14e9-4b0d-a797-b288db64d088/resource/1b97dffc-310e-4a30-bf9c-22fddff3f499/download/pitc202411.csv") %>% 
  clean_names()

data_dec_2024 = read_csv("https://www.opendata.nhs.scot/dataset/84393984-14e9-4b0d-a797-b288db64d088/resource/e4380152-3d16-446b-9072-108e93cf5caa/download/pitc202412.csv") %>% 
  clean_names()

pop_2024 = read_csv("https://www.opendata.nhs.scot/dataset/7f010430-6ce1-4813-b25c-f7f335bdc4dc/resource/27a72cc8-d6d8-430c-8b4f-3109a9ceadb1/download/hb2019_pop_est_03102025.csv") %>% 
  clean_names()%>%
  filter(year == 2024 &
           sex == "All") %>% 
  dplyr::select(hb, all_ages) 

### I'm plotting two graphs, to prove there is a trend to investigate
```

##### First we will collate our data into a list, so we can proccess it all with one command (future proofing)
```{r}
data_list_2024 = list(
  jun = data_jun_2024,
  jul = data_jul_2024,
  aug = data_aug_2024,
  sep = data_sep_2024,
  oct = data_oct_2024,
  nov = data_nov_2024,
  dec = data_dec_2024)

data_list_2023 = list(
  jun = data_jun_2023,
  jul = data_jul_2023,
  aug = data_aug_2023,
  sep = data_sep_2023,
  oct = data_oct_2023,
  nov = data_nov_2023,
  dec = data_dec_2023
)
```

##### We'll get rid of any collums which we won't need, so its easier to work with
```{r}
data_list_2024 = map(data_list_2024,
                ~ dplyr::select(
                  .x, -c(gp_practice,
                         dmd_code,
                         prescribed_type,
                         gross_ingredient_cost,
                         paid_date_month )))

data_list_2023 = map(data_list_2023,
                ~ dplyr::select(
                  .x, -c(gp_practice,
                         dmd_code,
                         prescribed_type,
                         gross_ingredient_cost,
                         paid_date_month )))
```

##### Antibiotics start their BNF code with "0510", so we will filter based on that
```{r}
filtered_data_list_2024 =  map(data_list_2024, ~
  filter(.x, startsWith(bnf_item_code, "05010")))
  
all_data_2024 = bind_rows(filtered_data_list_2024, .id = "month")

filtered_data_list_2023 =  map(data_list_2023, ~
  filter(.x, startsWith(bnf_item_code, "05010")))
  
all_data_2023 = bind_rows(filtered_data_list_2023, .id = "month")

```


### Joining our data to healthboards, and plotting on a map.
##### Lets read out map data


##### Lets join our map and healthboard perscription data
```{r, message=FALSE}
Joined_data_2024 = map %>% 
  right_join(all_data_2024, 
             join_by("HBCode" == "hbt" ))

tally_data_2024 = Joined_data_2024 %>% 
  group_by(HBName, 
           HBCode, 
           month) %>% 
  summarise(total_quanity = sum(paid_quantity, na.rm = TRUE)) %>% 
  full_join(pop_2024, 
            join_by("HBCode" == "hb"))


Joined_data_2023 = map %>% 
  right_join(all_data_2023, 
             join_by("HBCode" == "hbt" ))

tally_data_2023 = Joined_data_2023 %>% 
  group_by(HBName, 
           HBCode, 
           month) %>% 
  summarise(total_quanity = sum(paid_quantity, na.rm = TRUE)) %>% 
  full_join(pop_2024, 
            join_by("HBCode" == "hb"))

```


##### Now work out the perscription rate per capita
```{r}
Final_data_2024 = tally_data_2024 %>% 
  mutate(Dose_per_capita = total_quanity/all_ages)

Final_data_2023 = tally_data_2023 %>% 
  mutate(Dose_per_capita = total_quanity/all_ages)
```


##### Now make our data sets for each month that we want


```{r}
# Combine years for convenience
all_data <- bind_rows(
  Final_data_2023 %>% mutate(year = 2023),
  Final_data_2024 %>% mutate(year = 2024)
)
```


```{r}
Final_data_2023 <- Final_data_2023 %>% mutate(year = 2023)
Final_data_2024 <- Final_data_2024 %>% mutate(year = 2024)

all_data <- bind_rows(Final_data_2023, Final_data_2024)

# Ensure it's an sf object
all_data <- st_as_sf(all_data)
```


```{r}
# ------------------------------------------------------------
# UI
# ------------------------------------------------------------

ui <- fluidPage(
  titlePanel("Antibiotic Doses per Capita by Health Board"),
  sidebarLayout(
    sidebarPanel(
        selectInput("year", "Select Year", choices = c(2023, 2024)),
        selectInput("month", "Select Month", choices = c("jun","jul","aug","sep","oct","nov","dec"))
        ),
    mainPanel(
      plotOutput("antibiotic_map", height = "600px")
    )))

# ------------------------------------------------------------
# SERVER
# ------------------------------------------------------------

server = function(input, output, session) {
      filtered_data = reactive({
      all_data %>%
      filter(year == input$year, month == input$month)})
  
  output$antibiotic_map <- renderPlot({
    ggplot(filtered_data(), aes(fill = Dose_per_capita)) +
      geom_sf() +
      scale_fill_continuous(low = "white", high = "darkblue") +
      labs(
        title = paste("Antibiotic Doses per Capita —",
          toupper(input$month), input$year),
        fill = "Doses per capita"
      ) +
      theme_minimal()
  })
}

# ------------------------------------------------------------
# RUN APP
# ------------------------------------------------------------

shinyApp(ui, server)
```






## Plotting our map plots
```{r}
ggplot(data = June_2024, aes(fill = Dose_per_capita))+
  geom_sf()+
  scale_fill_continuous(
    low = "white",
    high = "darkblue",   
    limits = c(1.2, 3),
    labels = scales::label_comma())+
  labs(
    title = "Antibiotic Doses per Capita, June 2024",
    fill = "Prescriptions per capita") +
  theme_minimal()

ggplot(data = December_2024, aes(fill = Dose_per_capita))+
  geom_sf()+
  scale_fill_continuous(
    low = "white",
    high = "darkblue",   
    limits = c(1.2, 3),
    labels = scales::label_comma())+
  labs(
    title = "Antibiotic Doses per Capita, December 2024",
    fill = "Prescriptions per capita") +
  theme_minimal()
```
```
# Next steps:
##### 1) expand range of data, to include months inbetween, and 2023
##### 2) use facets/map to combine by year, possibly using .gif to display change too
##### 3) plot dose per capita over time, maybe also plot temperature data or hospital stats for conditions like pneumonia
##### 4) optimise process, remove any redunancies/ ineffecent orderings (data loading will be a large chuck if not optimised)
##### 5) annotate further and build narrative
