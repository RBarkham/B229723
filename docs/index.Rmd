---
title: "Assesment"
output: html_document
date: "2025-10-31"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
options(timeout = 600)
```


# R Programing Assignment - B229723
### Is there an assocation between antibiotic perscription rate and the seasons? How does this vary by healthboard?

Antibiotics are one of the most widely prescribed class of medications, with (insert number) of people being prescribed them annually in the UK. Consequently, understanding the factors which influence prescription is paramount. This is especially important with the rise of antibiotic resistance, where over prescription promotes antibiotic resistance. 

In this report, we are looking at the prescription rate of antibiotics over 2 summer-winter periods, and seeing if there is any correlation between prescription rate in health boards, and the minimum average temperature. With cold weather promoting respiritory conditions, one of the main uses of antibiotics, we could expect to see an uptick of prescription during colder weather.

To investigate this, we will be using perscription data from NHS Scotland, population data from the UK government website (provided ultimately by the Scottish government), and temperature data from the CEDA (orignally provided by the MET office). We will start by using static graphs show preliminary findings. Secondly, an interactive web widget to show temporal/spatial relationships 



##### First, lets load out packages in
```{R Package Load-in, message=FALSE, warning=FALSE}
library(tidyverse)
library(janitor)
library(gt)
library(sf)
library(terra)
library(exactextractr)
library(shiny)
library(glue)
library(rsconnect)
library(here)
library(lubridate)
library(reactable)
```


First lets load our temperature data, we can't directly download our data from the CEDA website due to the login required (and the API which bypasses this is not yet functional)

To solve this, whilst keeping our script portable, we can download it from the github repository. R studio get's a bit confused with .nc files, so we need to keep our data in a temporary file. We can then use this temporary file to properly load our data in


```{r Reading Temp Data, message=FALSE}
library(terra)
library(purrr)

URLs = c(
  "2023" = "https://github.com/RBarkham/B229723/raw/refs/heads/main/docs/data/temp_2023.nc",
  "2024" = "https://github.com/RBarkham/B229723/raw/refs/heads/main/docs/data/temp_2024.nc"
  )

Data_List_Temp = map(URLs, ~{
  Tmp_File = tempfile(fileext = ".nc")
  download.file(.x, Tmp_File, mode = "wb")
  rast(Tmp_File)
  })

Data_List_Temp = imap(Data_List_Temp, ~{
  names(.x) = c(paste0(.y, "_", month.name))
  (.x)
  })
#our data is in layers, one for each month. Currently the layers are named tasmin1, tasmin2 ect. This is difficult to understand. We use imaps() instead of maps here, becuase we want maps to keep a track of which year theyre from, and save it as .y. By using Names() we will rename these layers, (.x) applies it to both years; month.name is a in built vector which has all the months of the year. paste0() pastes whats sindie the brackets but removes any spaces the regular paste() function would have added - this is quicker than defining all the months manually. 

# Combine rasters into a single stack
All_Temp = c(Data_List_Temp$`2023`, 
             Data_List_Temp$`2024`) #we dont use merge(), as it doesn't deal with our SpatRaster object type well

```

Now, we want to plot this as a chloroplast, so we need to give R a map (Like how you have a colouring book to provide a guide, so you knwo where to colour in)

```{r Reading Map Data, message=FALSE}
Scotland_Map = st_read("/vsizip/vsicurl/https://maps.gov.scot/ATOM/shapefiles/SG_NHS_HealthBoards_2019.zip/SG_NHS_HealthBoards_2019.shp", quiet = TRUE) %>% 
  st_simplify( dTolerance = 1000) %>% #st_simplify makes our map data less data-intensive, and helps it run quicker
  st_transform( crs(All_Temp)) # st_transform makes sure that our map data will work with our temp data 

#because our temp data is the same, formating our data to one year will work on all years 

### https://cu-esiil.github.io/forest-carbon-codefest/collaborating-on-the-cloud/cyverse_data_management/ 
```



```{r Raster --> DF conversion, message=FALSE, paged.print=TRUE}
Temp_df = exact_extract(All_Temp, Scotland_Map, "mean" ,
                        full_colnames = FALSE, 
                        append_cols = "HBName") %>% 
                                                select(-matches("(January|February|March|April|May)"))

names(Temp_df) = gsub("mean.", "", names(Temp_df)) #exact_extract adds "mean." to our column names. You can't prevent this, so we'll have to remove it so we can reliabily proccess our data down the line

Temp_df_Long = Temp_df %>%
  pivot_longer(
    cols = -c(HBName),   # we select the colums we want to tien into rows (all except HBName which )
    names_to = "Year_Month",     # new column name for month
    values_to = "Min_Temperature"  # new column name for values
  ) %>% 
  separate("Year_Month", into = c("Year", "Month")) %>% 
  mutate(Year = as.numeric(Year))
```

```{r Joining Temp to Map Data}
dropdown_filter_temp = function(values, name) {
  tags$select(
    onchange = sprintf(
      "Reactable.setFilter('temp-table', '%s', event.target.value || undefined)",
      name),
    tags$option(value = "", "All"),            
    lapply(sort(unique(values)), tags$option),
    style = "width: 100%; height: 28px;")}

# Create the table
reactable(
  Temp_df_Long,
  filterable = TRUE,
  pagination = FALSE,
  height = 300,
  defaultColDef = colDef(
    filterInput = dropdown_filter_temp),
  columns = list(
    Min_Temperature = colDef(filterable = FALSE)),
  elementId = "temp-table"
)
```


```{R Reading in Antibioitics Data, message=FALSE}
Antibiotics_data = c( ##### First we will collate our data into a list, so we can process it all with one command, and add more data if required easily
  "2023_June" = "https://www.opendata.nhs.scot/dataset/84393984-14e9-4b0d-a797-b288db64d088/resource/66e9611a-fbea-45b2-9edd-351c388fd06d/download/pitc202306.csv",
  
  "2023_July" = "https://www.opendata.nhs.scot/dataset/84393984-14e9-4b0d-a797-b288db64d088/resource/7bb45ee6-6f1c-45f4-933b-958bdbe0ca4f/download/pitc202307.csv",
  
  "2023_August" = "https://www.opendata.nhs.scot/dataset/84393984-14e9-4b0d-a797-b288db64d088/resource/72ca4ad2-0228-4672-9eb0-cc911e4a8ca7/download/pitc202308.csv",
  
  "2023_September" = "https://www.opendata.nhs.scot/dataset/84393984-14e9-4b0d-a797-b288db64d088/resource/2d3d240f-1467-4a91-9f0e-769745650cb9/download/pitc202309.csv",
  
  "2023_October" = "https://www.opendata.nhs.scot/dataset/84393984-14e9-4b0d-a797-b288db64d088/resource/94134438-db1d-4b8d-8f70-5e9b0e47bd03/download/pitc202310.csv",
  
  "2023_November" = "https://www.opendata.nhs.scot/dataset/84393984-14e9-4b0d-a797-b288db64d088/resource/21d11fed-a494-4e30-9bb6-46143c3b9530/download/pitc202311.csv",
  
 "2023_December" = "https://www.opendata.nhs.scot/dataset/84393984-14e9-4b0d-a797-b288db64d088/resource/00cdf8d7-f784-4e87-894c-34f2540ea6ab/download/pitc202312.csv",
 
  "2024_June" = "https://www.opendata.nhs.scot/dataset/84393984-14e9-4b0d-a797-b288db64d088/resource/95f7f250-bd04-4e4a-b853-5df75b00a632/download/pitc202406.csv",
 
  "2024_July" = "https://www.opendata.nhs.scot/dataset/84393984-14e9-4b0d-a797-b288db64d088/resource/1cb425fc-640c-4b37-9013-f8e97f274085/download/pitc202407.csv",
 
  "2024_August" = "https://www.opendata.nhs.scot/dataset/84393984-14e9-4b0d-a797-b288db64d088/resource/e4985a62-9d59-4e71-8800-3f7ca29ffe0c/download/pitc202408.csv",
 
  "2024_September" = "https://www.opendata.nhs.scot/dataset/84393984-14e9-4b0d-a797-b288db64d088/resource/d1fbede3-98c4-436e-9e75-2ed807a36075/download/pitc202409.csv",
 
  "2024_October" = "https://www.opendata.nhs.scot/dataset/84393984-14e9-4b0d-a797-b288db64d088/resource/0d27f6e8-5f8b-42c4-9fe9-c44389af2d3e/download/pitc202410.csv",
 
  "2024_November" = "https://www.opendata.nhs.scot/dataset/84393984-14e9-4b0d-a797-b288db64d088/resource/1b97dffc-310e-4a30-bf9c-22fddff3f499/download/pitc202411.csv",
 
  "2024_December" = "https://www.opendata.nhs.scot/dataset/84393984-14e9-4b0d-a797-b288db64d088/resource/e4380152-3d16-446b-9072-108e93cf5caa/download/pitc202412.csv")

Data_List_Antibiotics = map(Antibiotics_data, ~ 
                            read_csv(.x) %>% 
                            clean_names()
                            ) 
## you'll notice we had an error when we were loading "Parsing issue", lets check that out
```


```{r Error investigation}
map(Data_List_Antibiotics, ~problems(.x)) ### we can see that there is missing data for Sucralfate (Nu), on Row Number 150,115 in Nov_2023 (our 6th tibble, and our 6th month)

error = Data_List_Antibiotics$`2023_November` %>% 
  slice(150114) # we want to isolate the problematic row, so we will use slice() to isolate by row number. We have to take 1 off our number, to account for the fact the slice() doesn't count the header, like base r does in problems(} 

# we can see that there no paid_quantity, gross_ingredient_cost nor paid_date_month, so was missing 3 columns. However, this isn't for an antibiotic, so it's not relevant for our purposes and we can ignore it safely.
```


```{r Reading in Pop Data, message=FALSE}
pop = read_csv("https://www.opendata.nhs.scot/dataset/7f010430-6ce1-4813-b25c-f7f335bdc4dc/resource/27a72cc8-d6d8-430c-8b4f-3109a9ceadb1/download/hb2019_pop_est_03102025.csv") %>% 
  clean_names()%>%
  filter(year %in% c("2023", "2024") &
           sex == "All" &
           hb != "S92000003") %>% 
  dplyr::select(hb, all_ages, year) 
```




##### We'll get rid of any collums which we won't need, so its easier to work with


####


### Joining our data to healthboards, and plotting on a map.
##### Lets read out map data

##### Lets join our map and healthboard perscription data
```{r Filtering and Combining Antibiotics Data, message=FALSE}
Slimmed_data_list_Antibiotics = Data_List_Antibiotics %>%
  map(~ dplyr::select(
                    .x, -c(gp_practice,
                    dmd_code,
                    prescribed_type,
                    gross_ingredient_cost,
                    paid_date_month,
                    number_of_paid_items)))
#we don't need this information, so we'll remove it to lighten our processing load

Filtered_Data_List_Antibiotics = map(Slimmed_data_list_Antibiotics,
    ~filter(.x, startsWith(bnf_item_code, "05010") &
              hbt != "SB0806")) 
  # Antibiotics start their BNF code with "0510", so we will filter based on that

Antibiotics_data = Filtered_Data_List_Antibiotics %>%
  bind_rows(.id = "Year_Month") %>%
  separate("Year_Month", into = c("Year", "Month")) %>% 
  mutate(Year = as.numeric(Year))
```

```{r Calculating Stats and Joining Healthboard Data, paged.print=TRUE}
Tally_Antibiotics_Data = Antibiotics_data %>% 
  group_by(hbt,
           Year,
           Month) %>% 
  summarise(total_quanity = sum(paid_quantity, na.rm = TRUE), .groups = "keep")

Antibiotics_pop_data = Tally_Antibiotics_Data %>% 
  left_join(pop, join_by(hbt == hb, Year == year)) #by using left join, we tell R to keep the long months rather than short ones.


Antibiotics_dose_pc = Antibiotics_pop_data %>% 
  mutate(Dose_per_capita = total_quanity/all_ages) %>% 
  subset(select = -c(all_ages, total_quanity))

```

```{r Joining Antibiotic and Map Data}
Antibiotics_Map = Scotland_Map %>% 
  full_join(Antibiotics_dose_pc, 
             join_by(HBCode == hbt))%>% 
  relocate(c("Shape_Leng", "Shape_Area"), .before = geometry)

  Antibiotics_Map_Table = Antibiotics_Map %>%
    st_drop_geometry() %>% 
  select(-HBCode, -Shape_Leng, -Shape_Area)

saveRDS(Antibiotics_Map, here("Data/Antibiotics_Map_Server.rds")) # we'll save this for later
```


```{r Antibiotics Data Table}
library(reactable)

# Dropdown filter function
dropdown_filter_Antibiotics = function(values, name) {
  tags$select(
    onchange = sprintf(
      "Reactable.setFilter('antibiotics-table', '%s', event.target.value || undefined)", name),
    tags$option(value = "", "All"),
    lapply(sort(unique(values)), tags$option),
    style = "width: 100%; height: 30px;"
  )}

# Create the table
reactable(
  Antibiotics_Map_Table,
  filterable = TRUE,
  pagination = FALSE,
  height = 700,
  defaultColDef = colDef(
    filterInput = dropdown_filter_Antibiotics),
  columns = list(
    Dose_per_capita = colDef(filterable = FALSE)),
  elementId = "antibiotics-table")

```

```{r Preliminary Graphs}
June_December_Antibiotics = Antibiotics_Map_Table %>%
  filter(Month %in% c("June", "December")) # we don't need the mapping data, so we'll use the version before it.

June_December_Temp = Temp_df_Long %>%  
                          filter(Month %in% c("June", "December"))

June_December_joined = full_join(Temp_df_Long, Antibiotics_dose_pc, relationship = "many-to-many") %>% 
  ungroup() %>% select(-hbt) # we have alot of overlapping data, so we can disable the "many-to-many" warning which warns you that you might be joining duplicates
                          
ggplot(June_December_Antibiotics, aes(x = HBName, y = Dose_per_capita, fill = Month)) +
  geom_bar(stat = "identity", position = "dodge") +
  facet_wrap(~ Year) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
  
ggplot(June_December_Temp, aes(x = HBName, y = Min_Temperature, fill = Month)) +
  geom_bar(stat = "identity", position = "dodge") +
  facet_wrap(~ Year) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

ggplot(June_December_joined, aes(x = Min_Temperature, y = Dose_per_capita)) +
  geom_point(size = 1, color = "blue") +
  facet_wrap(~ Year) +
  geom_smooth(method = "lm", se = FALSE, color = "red") +  # optional trend line
  labs(x = "Minimum Temperature", y = "Dose per Capita",
       title = "Scatter plot of Dose per Capita vs Minimum Temperature") +
  theme_minimal()
```










Now, we're going to make our data interactive, so you'll have a widget where you can browse graphs by year and month.

to to this, we are going to use a new package and file type called Shiny, and will also use Shiny.IO to help run the widget.

We make a new folder in our project (In this case its B229723), our widget has to be in its own folder 

Next we open a new Shiny document (File-->New File-->Shiny Web App), and ensure its in our new folder.

Next we have to construct a Shiny app. to construct a Shiny app, we need three parts.

Firstly, we need the data for the graphs (This is Final_data_server)
Secondly, we need a UI (How we tell the app what our variables are, and what the option are. On top of this, The UI controls charts will be displayed to us, i.e width and height)
Lastly, we need a server (the brains of the app, which interprets our selections/inputs to produce a output (a graph))


```{r Shiny App, eval=FALSE}
---
#Shiny web app
---
library(shiny)
library(scales)
library(sf)
library(dplyr)
library(ggplot2)
library(lubridate)  # Added for potential date handling

Antibiotics_Map_Server = readRDS("Antibiotics_Map_Server.rds")
Temp_Map_Server = readRDS("Temp_Map_Server.rds")

UI <- fluidPage(
  titlePanel("Antibiotic Doses per Capita by Health Board"),
  sidebarLayout(
    sidebarPanel(
      selectInput("Year", "Select Year", 
                  choices = c(2023, 2024)),
      selectInput("Month", "Select Month", 
                  choices = c("June", "July", "August", "September", 
                              "October", "November", "December"))),
    mainPanel(
      fluidRow(splitLayout(cellWidths = c("50%", "50%"),
      plotOutput("Antibiotic_Map", height = "1000px"), plotOutput("Min_Temp_Map", height = "1000px")
      )))
  )
)

Server <- function(input, output, session) {
  
  Filtered_Data_Antibiotics <- reactive({
    Antibiotics_Map_Server %>%
      filter(Year == input$Year,
             Month == input$Month)
  })
   
  Filtered_Data_Min_Temp <- reactive({
    Temp_Map_Server %>%
      filter(Year == input$Year,
             Month == input$Month)
  })
  
  output$Antibiotic_Map <- renderPlot({
    Antibiotics_Data = Filtered_Data_Antibiotics()
    ggplot(Antibiotics_Data, aes(fill = Dose_per_capita)) +
      geom_sf(color = "#e6f2ff", size = 0.5) +
      scale_fill_continuous(
        low = "darkblue", high = "white", 
        limits = c(1.2, 3),
        labels = label_comma()) +
      labs(
        title = paste("Antibiotic Doses per Capita —",
                      input$Month, input$Year),
        subtitle = "By Scottish Health Boards"
      ) +
      theme_minimal() +
      theme(legend.position = "bottom")
    
  })

  output$Min_Temp_Map = renderPlot({
    Data_Min_Temp = Filtered_Data_Min_Temp()
    ggplot(Data_Min_Temp, aes(fill = Min_Temperature)) +
      geom_sf(color = "#e6f2ff", size = 0.5) +
      scale_fill_continuous(
        low = "darkblue", high = "white", 
        limits = c(-0.75, 11.5),
        labels = label_number()) +
      labs(
        title = paste("Minimum Temperature —",
                      toupper(input$Month), input$Year),
        subtitle = "By Scottish Health Boards"
      ) +
      theme_minimal() +
      theme(legend.position = "bottom")
  })
}

shinyApp(UI, Server)) #tells R to run the app
```



<iframe 
  src="https://rbarkham.shinyapps.io/antibiotics_map/"
  width="100%" 
  height="900px"
  style="border: 1px solid #ccc; border-radius: 8px;"
  frameborder="0"
  scrolling="yes">
</iframe>

Fromt the plots we can see an inverse relationship 

## Plotting our map plots

# Next steps:
##### 1) expand range of data, to include months inbetween, and 2023
##### 2) use facets/map to combine by year, possibly using .gif to display change too
##### 3) plot dose per capita over time, maybe also plot temperature data or hospital stats for conditions like pneumonia
##### 4) optimise process, remove any redunancies/ ineffecent orderings (data loading will be a large chuck if not optimised)
##### 5) annotate further and build narrative
