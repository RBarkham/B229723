---
title: "Assesment"
output: html_document
date: "2025-10-31"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# R Programing Assignment - B229723
### Is there an assocation between antibiotic perscription rate and the seasons? How does this vary by healthboard?



##### First, lets load out packages in
```{R, message=FALSE}
library(tidyverse)
library(janitor)
library(gt) 
library(here)
library(sf)
```

##### And now our data, we'll be looking from June-December (Summer to winter) across 2023, and 2024. These data files are large, so it may take some time for the chunk to run. (Only doing 2024 for now)


```{R, message=FALSE}
data_jun_2024 = read_csv("https://www.opendata.nhs.scot/dataset/84393984-14e9-4b0d-a797-b288db64d088/resource/95f7f250-bd04-4e4a-b853-5df75b00a632/download/pitc202406.csv") %>% 
  clean_names()

data_dec_2024 = read_csv("https://www.opendata.nhs.scot/dataset/84393984-14e9-4b0d-a797-b288db64d088/resource/e4380152-3d16-446b-9072-108e93cf5caa/download/pitc202412.csv") %>% 
  clean_names()

pop_2024 = read_csv("https://www.opendata.nhs.scot/dataset/7f010430-6ce1-4813-b25c-f7f335bdc4dc/resource/27a72cc8-d6d8-430c-8b4f-3109a9ceadb1/download/hb2019_pop_est_03102025.csv") %>% 
  clean_names()%>% 
  filter(year == 2024 &
           sex == "All") %>% 
  select(hb, all_ages) 

### I'm plotting two graphs, to prove there is a trend to investigate
```

##### First we will collate our data into a list, so we can proccess it all with one command (future proofing)
```{r}
data_list_2024 <- list(
  jun = data_jun_2024,
  dec = data_dec_2024)
```

##### We'll get rid of any collums which we won't need, so its easier to work with
```{r}
data_list_2024 = map(data_list_2024,
                ~ select(
                  .x, -c(gp_practice,
                         dmd_code,
                         prescribed_type,
                         gross_ingredient_cost,
                         paid_date_month )))
```

##### Antibiotics start their BNF code with "0510", so we will filter based on that
```{r}
filtered_data_list_2024 =  map(data_list_2024, ~
  filter(.x, startsWith(bnf_item_code, "05010")))
  
all_data_2024 = bind_rows(filtered_data_list_2024, .id = "month")

```


### Joining our data to healthboards, and plotting on a map.
##### Lets read out map data
```{r, message=FALSE}
map = st_read("data/shapefile/NHS_Healthboards_2019.shp", quiet = TRUE)
```

##### Lets join our map and healthboard perscription data
```{r, message=FALSE}
Joined_data_2024 = map %>% 
  right_join(all_data_2024, 
             join_by("HBCode" == "hbt" ))

tally_data_2024 = Joined_data_2024 %>% 
  group_by(HBName, 
           HBCode, 
           month) %>% 
  summarise(total_quanity = sum(paid_quantity, na.rm = TRUE)) %>% 
  full_join(pop_2024, 
            join_by("HBCode" == "hb"))

```


##### Now work out the perscription rate per capita
```{r}
Final_data_2024 = tally_data_2024 %>% 
  mutate(Dose_per_capita = total_quanity/all_ages)
```


##### Now make our data sets for each month that we want
```{r}
June_2024 = Final_data_2024 %>% filter( month == "jun")
December_2024 = Final_data_2024 %>% filter( month == "dec")

```


## Plotting our map plots
```{r}
ggplot(data = June_2024, aes(fill = Dose_per_capita))+
  geom_sf()+
  scale_fill_continuous(
    low = "white",
    high = "darkblue",   
    limits = c(1.2, 3),
    labels = scales::label_comma())+
  labs(
    title = "Antibiotic Doses per Capita, June 2024",
    fill = "Prescriptions per capita") +
  theme_minimal()

ggplot(data = December_2024, aes(fill = Dose_per_capita))+
  geom_sf()+
  scale_fill_continuous(
    low = "white",
    high = "darkblue",   
    limits = c(1.2, 3),
    labels = scales::label_comma())+
  labs(
    title = "Antibiotic Doses per Capita, December 2024",
    fill = "Prescriptions per capita") +
  theme_minimal()
```

# Next steps:
##### 1) expand range of data, to include months inbetween, and 2023
##### 2) use facets/map to combine by year, possibly using .gif to display change too
##### 3) plot dose per capita over time, maybe also plot temperature data or hospital stats for conditions like pneumonia
##### 4) optimise process, remove any redunancies/ ineffecent orderings (data loading will be a large chuck if not optimised)
##### 5) annotate further and build narrative
